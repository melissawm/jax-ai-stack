
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Image Captioning with Vision Transformer (ViT) model &#8212; JAX AI Stack</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=1dc24ef2" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=c1d4a9c3"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'JAX_image_captioning';</script>
    <link rel="icon" href="_static/favicon.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Train a Vision Transformer (ViT) for image classification with JAX" href="JAX_Vision_transformer.html" />
    <link rel="prev" title="Image segmentation with UNETR model" href="JAX_examples_image_segmentation.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/ai-stack-logo.svg" class="logo__image only-light" alt="JAX AI Stack - Home"/>
    <script>document.write(`<img src="_static/ai-stack-logo.svg" class="logo__image only-dark" alt="JAX AI Stack - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    JAX AI Stack
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="blog.html">JAX AI Stack Blog</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing the stack</a></li>

<li class="toctree-l1 has-children"><a class="reference internal" href="getting_started.html">Getting started with JAX for ML</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="neural_net_basics.html">Part 1: JAX neural net basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="digits_vae.html">Part 2: Debug a variational autoencoder (VAE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="digits_diffusion_model.html">Part 3: Train a diffusion model for image generation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="JAX_visualizing_models_metrics.html">Visualize JAX model metrics with TensorBoard</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="data_loaders.html">Introduction to Data Loaders</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="data_loaders_on_cpu_with_jax.html">Introduction to Data Loaders on CPU with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_loaders_on_gpu_with_jax.html">Introduction to Data Loaders on GPU with JAX</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="pytorch_users.html">From PyTorch to JAX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="JAX_for_PyTorch_users.html">JAX for PyTorch users</a></li>
<li class="toctree-l2"><a class="reference internal" href="JAX_porting_PyTorch_model.html">Porting a PyTorch model to JAX</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Example applications</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="JAX_for_LLM_pretraining.html">Train a miniGPT language model with JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="JAX_basic_text_classification.html">Basic text classification with 1D CNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="JAX_transformer_text_classification.html">Text classification with a transformer language model using JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="JAX_machine_translation.html">Machine Translation with encoder-decoder transformer model</a></li>
<li class="toctree-l1"><a class="reference internal" href="JAX_examples_image_segmentation.html">Image segmentation with UNETR model</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Image Captioning with Vision Transformer (ViT) model</a></li>
<li class="toctree-l1"><a class="reference internal" href="JAX_Vision_transformer.html">Train a Vision Transformer (ViT) for image classification with JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="JAX_time_series_classification.html">Time series classification with CNN</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contribute to documentation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/jax-ml/jax-ai-stack" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/JAX_image_captioning.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Image Captioning with Vision Transformer (ViT) model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-image-captioning-dataset-and-dataloaders">Prepare image captioning dataset and dataloaders</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model">Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pretrained-vision-transformer">Pretrained Vision Transformer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transformer-decoder">Transformer decoder</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-captioning-model">Image Captioning Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-the-model">Train the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further reading</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section class="tex2jax_ignore mathjax_ignore" id="image-captioning-with-vision-transformer-vit-model">
<h1>Image Captioning with Vision Transformer (ViT) model<a class="headerlink" href="#image-captioning-with-vision-transformer-vit-model" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/jax-ml/jax-ai-stack/blob/main/docs/source/JAX_image_captioning.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<p>In this tutorial we implement from scratch and train a transformer-based model on the image captioning task. This task consists of generating a caption text for the input image. We train the model on <a class="reference external" href="http://hockenmaier.cs.illinois.edu/Framing_Image_Description/KCCA.html">Flickr8k</a> dataset and briefly test trained model on few test images. This tutorial is inspired by <a class="reference external" href="https://keras.io/examples/vision/image_captioning/">“Image Captioning with Keras”</a>.</p>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<p>We will be using the following packages in this tutorial:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/openai/tiktoken">Tiktoken</a> to tokenize the raw text</p></li>
<li><p><a class="reference external" href="https://github.com/google/grain">Grain</a> for efficient data loading and batching</p></li>
<li><p><a class="reference external" href="https://tqdm.github.io/">tqdm</a> for a progress bar to monitor the training progress</p></li>
<li><p>HuggingFace <a class="reference external" href="https://huggingface.co/docs/datasets/">Datasets</a> will be used for dataset provision</p></li>
<li><p><a class="reference external" href="https://pytorch.org/vision">TorchVision</a> will be used for image augmentations</p></li>
<li><p><a class="reference external" href="https://matplotlib.org/stable/">Matplotlib</a> will be used for visualization purposes</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install -U datasets grain torchvision tqdm transformers matplotlib tiktoken</span>
<span class="c1"># !pip install -U flax optax orbax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s use 90% of GPU memory:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;XLA_PYTHON_CLIENT_MEM_FRACTION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.9&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">flax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">optax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">orbax.checkpoint</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ocp</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Jax version:&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flax version:&quot;</span><span class="p">,</span> <span class="n">flax</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optax version:&quot;</span><span class="p">,</span> <span class="n">optax</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orbax version:&quot;</span><span class="p">,</span> <span class="n">ocp</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Jax version: 0.4.34
Flax version: 0.10.1
Optax version: 0.2.4
Orbax version: 0.9.1
</pre></div>
</div>
</div>
</div>
</section>
<section id="prepare-image-captioning-dataset-and-dataloaders">
<h2>Prepare image captioning dataset and dataloaders<a class="headerlink" href="#prepare-image-captioning-dataset-and-dataloaders" title="Link to this heading">#</a></h2>
<p>In this section we will set up the dataflow for our image captioning task. We will be using <a class="reference external" href="http://hockenmaier.cs.illinois.edu/Framing_Image_Description/KCCA.html">Flickr8k</a> dataset as a training dataset and download a copy from the <a class="reference external" href="https://huggingface.co/datasets/clip-benchmark/wds_flickr8k">HuggingFace Datasets hub</a>. The dataset contains 8,000 images that are each paired with five different captions which provide clear descriptions of the salient entities and events.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>


<span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;clip-benchmark/wds_flickr8k&quot;</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

<span class="c1"># Remap datapoint key names</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remap_keys</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;jpg&quot;</span><span class="p">],</span>
        <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;txt&quot;</span><span class="p">],</span>
    <span class="p">}</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="n">remap_keys</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="n">remap_keys</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training dataset size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test dataset size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training dataset size: 6000
Test dataset size: 1000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>


<span class="k">def</span><span class="w"> </span><span class="nf">display_datapoints</span><span class="p">(</span><span class="o">*</span><span class="n">datapoints</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datapoints</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datapoints</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">captions</span> <span class="o">=</span> <span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">captions</span> <span class="o">=</span> <span class="n">datapoint</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">captions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cap_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cap</span> <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">captions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cap_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tensor shape: </span><span class="si">{</span><span class="n">captions</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">captions</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">Caption:</span><span class="se">\n</span><span class="si">{</span><span class="n">cap_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_datapoints</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">1000</span><span class="p">],</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">2000</span><span class="p">],</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;(Training) &quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">display_datapoints</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_dataset</span><span class="p">[</span><span class="mi">500</span><span class="p">],</span> <span class="n">test_dataset</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;(Test) &quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/077b2a35db90479e75078fa9a8392bca9752d7211df6f562416fc2d6eedca41d.png" src="_images/077b2a35db90479e75078fa9a8392bca9752d7211df6f562416fc2d6eedca41d.png" />
<img alt="_images/7c7d383240e44722d0acfe253189ce72955a94c09961191061d3fd6ef6078314.png" src="_images/7c7d383240e44722d0acfe253189ce72955a94c09961191061d3fd6ef6078314.png" />
</div>
</div>
<p>Below we define image and text transformations. We will be using <a class="reference external" href="https://pytorch.org/vision">TorchVision</a> to transform input images. Training image transformations will also contain random augmentations to prevent overfitting and make trained model more robust. For the captions we pick the longest caption among 5 captions and we are going to use the GPT-2 tokenizer via <a class="reference external" href="https://github.com/openai/tiktoken">Tiktoken</a> to make a string-to-tokens preprocessing transformation: text string into integer tensors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">grain.python</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">grain</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tiktoken</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">v2</span> <span class="k">as</span> <span class="n">T</span>


<span class="n">seed</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">train_batch_size</span> <span class="o">=</span> <span class="mi">196</span>
<span class="n">test_batch_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">train_batch_size</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">150</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;gpt2&quot;</span><span class="p">)</span>
<span class="n">vocab_size</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">n_vocab</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_np_array</span><span class="p">(</span><span class="n">pil_image</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pil_image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="c1"># We use here the normalization parameters matching</span>
    <span class="c1"># pretrained ViT from HF Transformers:</span>
    <span class="c1"># ViTImageProcessor.from_pretrained(&#39;google/vit-base-patch16-224&#39;)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>


<span class="n">train_transforms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">T</span><span class="o">.</span><span class="n">RandomResizedCrop</span><span class="p">((</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">to_np_array</span><span class="p">),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">normalize</span><span class="p">),</span>
<span class="p">])</span>


<span class="n">test_transforms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">to_np_array</span><span class="p">),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">normalize</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, using <a class="reference external" href="https://github.com/google/grain/"><code class="docutils literal notranslate"><span class="pre">grain</span></code></a> we put all transformations into <code class="docutils literal notranslate"><span class="pre">grain.MapTransform</span></code> and create dataloaders for efficient data loading.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ImageTransforms</span><span class="p">(</span><span class="n">grain</span><span class="o">.</span><span class="n">MapTransform</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tv_transforms</span><span class="p">:</span> <span class="nb">callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tv_transforms</span> <span class="o">=</span> <span class="n">tv_transforms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tv_transforms</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
            <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="n">start_tag</span> <span class="o">=</span> <span class="s2">&quot;[start]&quot;</span>
<span class="n">end_tag</span> <span class="o">=</span> <span class="s2">&quot;[end]&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TextPreprocessing</span><span class="p">(</span><span class="n">grain</span><span class="o">.</span><span class="n">MapTransform</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">use_longest_caption</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str_trans_table</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_longest_caption</span> <span class="o">=</span> <span class="n">use_longest_caption</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># We remove all punctuation chars using s.translate()</span>
        <span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="n">cap</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_str_trans_table</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_longest_caption</span><span class="p">:</span>
            <span class="c1"># Use the longest caption</span>
            <span class="n">longest_caption</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">captions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">start_tag</span> <span class="o">+</span> <span class="n">longest_caption</span> <span class="o">+</span> <span class="n">end_tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Let&#39;s join all captions as:</span>
            <span class="c1"># start_tag + cap1 + eng_tag + start_tag + cap2 + eng_tag + ... + start_tag + cap5 + eng_tag</span>
            <span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">captions</span><span class="p">:</span>
                <span class="n">text_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">start_tag</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">end_tag</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_list</span><span class="p">)</span>

        <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span> <span class="n">allowed_special</span><span class="o">=</span><span class="p">{</span><span class="n">start_tag</span><span class="p">,</span> <span class="n">end_tag</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Cut to max length</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span>
        <span class="c1"># Pad with zeros if needed</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">encoded</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">encoded</span><span class="p">,</span>
            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>
        <span class="p">}</span>


<span class="n">train_sampler</span> <span class="o">=</span> <span class="n">grain</span><span class="o">.</span><span class="n">IndexSampler</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
    <span class="n">shard_options</span><span class="o">=</span><span class="n">grain</span><span class="o">.</span><span class="n">NoSharding</span><span class="p">(),</span>  <span class="c1"># No sharding since this is a single-device setup</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                      <span class="c1"># Iterate over the dataset for one epoch</span>
<span class="p">)</span>

<span class="n">test_sampler</span> <span class="o">=</span> <span class="n">grain</span><span class="o">.</span><span class="n">IndexSampler</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">),</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
    <span class="n">shard_options</span><span class="o">=</span><span class="n">grain</span><span class="o">.</span><span class="n">NoSharding</span><span class="p">(),</span>  <span class="c1"># No sharding since this is a single-device setup</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                      <span class="c1"># Iterate over the dataset for one epoch</span>
<span class="p">)</span>


<span class="n">train_loader</span> <span class="o">=</span> <span class="n">grain</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">data_source</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
    <span class="n">sampler</span><span class="o">=</span><span class="n">train_sampler</span><span class="p">,</span>                 <span class="c1"># Sampler to determine how to access the data</span>
    <span class="n">worker_count</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>                        <span class="c1"># Number of child processes launched to parallelize the transformations among</span>
    <span class="n">worker_buffer_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>                  <span class="c1"># Count of output batches to produce in advance per worker</span>
    <span class="n">operations</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ImageTransforms</span><span class="p">(</span><span class="n">train_transforms</span><span class="p">),</span>
        <span class="n">TextPreprocessing</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">),</span>
        <span class="n">grain</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">test_loader</span> <span class="o">=</span> <span class="n">grain</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">data_source</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">sampler</span><span class="o">=</span><span class="n">test_sampler</span><span class="p">,</span>                  <span class="c1"># Sampler to determine how to access the data</span>
    <span class="n">worker_count</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>                        <span class="c1"># Number of child processes launched to parallelize the transformations among</span>
    <span class="n">worker_buffer_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>                  <span class="c1"># Count of output batches to produce in advance per worker</span>
    <span class="n">operations</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ImageTransforms</span><span class="p">(</span><span class="n">test_transforms</span><span class="p">),</span>
        <span class="n">TextPreprocessing</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">),</span>
        <span class="n">grain</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">test_batch_size</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize training and validation batches</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
<span class="n">test_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training batch info:&quot;</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test batch info:&quot;</span><span class="p">,</span> <span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training batch info: (196, 224, 224, 3) float32 (196, 150) int64
Test batch info: (250, 224, 224, 3) float32 (250, 150) int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_datapoints</span><span class="p">(</span>
    <span class="o">*</span><span class="p">[(</span><span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)],</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;(Training) &quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7e953174f13ab77dbd1f955357c338e642b15f234dde72cf18009ac6e0fa622a.png" src="_images/7e953174f13ab77dbd1f955357c338e642b15f234dde72cf18009ac6e0fa622a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_datapoints</span><span class="p">(</span>
    <span class="o">*</span><span class="p">[(</span><span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)],</span>
    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;(Test) &quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2f0f9e4f4f2ccd498ddc671e5e6e726559c56a16e918a33c53afef97a6b1eae0.png" src="_images/2f0f9e4f4f2ccd498ddc671e5e6e726559c56a16e918a33c53afef97a6b1eae0.png" />
</div>
</div>
<p>Let’s take a closer look at encoded and decoded captions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cap</span> <span class="o">=</span> <span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encoded caption:&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Decoded caption:&quot;</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">cap</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Encoded caption: [   58  9688    60    32  2042   290  7586  6844 10427   257  2266 40529
    58   437    60   685  9688    60    32  2042  3290 36615   319   257
  2266 40529    58   437    60   685  9688    60    32  3290  1125 18504
   319   465  2266 40529    58   437    60   685  9688    60    32  3290
   286  3223  3124  6622   257  2266 40529   287   465  5422    58   437
    60   685  9688    60    64  3290   256 10339   319   465  2266 40529
    58   437    60   220     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
     0     0     0     0     0     0]
Decoded caption: [start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</pre></div>
</div>
</div>
</div>
</section>
<section id="model">
<h2>Model<a class="headerlink" href="#model" title="Link to this heading">#</a></h2>
<p>We implement from scratch a transformer-based model for the image captioning task. The model contains two part:</p>
<ul class="simple">
<li><p>transformer encoder (<a class="reference external" href="https://arxiv.org/abs/2010.11929">Vision Transformer</a> pretrained on the ImageNet): it takes input image and returns a sequence of tokens corresponding to the input image.</p></li>
<li><p>transformer decoder: it takes two inputs: 1) the encoder output: a sequence of image tokens, 2) a sequence of caption tokens, a context, and returns the new sequence caption tokens containing previous tokens and one generated next token.</p></li>
</ul>
<section id="pretrained-vision-transformer">
<h3>Pretrained Vision Transformer<a class="headerlink" href="#pretrained-vision-transformer" title="Link to this heading">#</a></h3>
<p>Below we implement from scratch Vision Transformer (ViT) model based on the paper by Dosovitskiy et al: <a class="reference external" href="https://arxiv.org/abs/2010.11929">An Image is Worth 16x16 Words: Transformers for Image Recognition at Scale</a>. We add an additional flag to skip the classification head and return the sequence of image tokens.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flax</span><span class="w"> </span><span class="kn">import</span> <span class="n">nnx</span>


<span class="k">class</span><span class="w"> </span><span class="nc">VisionTransformer</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">img_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
        <span class="n">patch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">mlp_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3072</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">include_top</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="c1"># Patch and position embedding</span>
        <span class="n">n_patches</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">//</span> <span class="n">patch_size</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_embeddings</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">initializer</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_embeddings</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span>
            <span class="n">initializer</span><span class="p">(</span><span class="n">rngs</span><span class="o">.</span><span class="n">params</span><span class="p">(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_patches</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)))</span>

        <span class="c1"># Transformer Encoder blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">mlp_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_norm</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">include_top</span> <span class="o">=</span> <span class="n">include_top</span>
        <span class="c1"># Classification head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

        <span class="c1"># store config info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dim</span> <span class="o">=</span> <span class="n">mlp_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
        <span class="c1"># Patch and position embedding</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embeddings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">patches</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">cls_token</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cls_token</span><span class="p">,</span> <span class="n">patches</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_embeddings</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>

        <span class="c1"># Encoder blocks</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_top</span><span class="p">:</span>
            <span class="c1"># fetch the first token</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Classification</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TransformerEncoder</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mlp_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">MultiHeadAttention</span><span class="p">(</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
            <span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
            <span class="n">broadcast_dropout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">mlp_dim</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">gelu</span><span class="p">,</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">mlp_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="c1"># We use a configuration to make smaller model to reduce the training time</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">VisionTransformer</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictions shape: &quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="n">params</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Param</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of model parameters: &quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">params</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Predictions shape:  (4, 1000)
Number of model parameters:  86567656
</pre></div>
</div>
</div>
</div>
<p>Let’s now load the weights pretrained on the ImageNet dataset using HuggingFace Transformers</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">FlaxViTForImageClassification</span>

<span class="n">tf_model</span> <span class="o">=</span> <span class="n">FlaxViTForImageClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;google/vit-base-patch16-224&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vit_inplace_copy_weights</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">src_model</span><span class="p">,</span> <span class="n">dst_model</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_model</span><span class="p">,</span> <span class="n">FlaxViTForImageClassification</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst_model</span><span class="p">,</span> <span class="n">VisionTransformer</span><span class="p">)</span>

    <span class="n">tf_model_params</span> <span class="o">=</span> <span class="n">src_model</span><span class="o">.</span><span class="n">params</span>
    <span class="n">tf_model_params_fstate</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">traversals</span><span class="o">.</span><span class="n">flatten_mapping</span><span class="p">(</span><span class="n">tf_model_params</span><span class="p">)</span>

    <span class="n">flax_model_params</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="n">dst_model</span><span class="p">,</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Param</span><span class="p">)</span>
    <span class="n">flax_model_params_fstate</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flax_model_params</span><span class="o">.</span><span class="n">flat_state</span><span class="p">())</span>

    <span class="n">src_num_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tf_model_params_fstate</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">dst_num_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">flax_model_params_fstate</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">assert</span> <span class="n">src_num_params</span> <span class="o">==</span> <span class="n">dst_num_params</span>

    <span class="n">params_name_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="p">(</span><span class="s2">&quot;cls_token&quot;</span><span class="p">,):</span> <span class="p">(</span><span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;embeddings&quot;</span><span class="p">,</span> <span class="s2">&quot;cls_token&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;position_embeddings&quot;</span><span class="p">,):</span> <span class="p">(</span><span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;embeddings&quot;</span><span class="p">,</span> <span class="s2">&quot;position_embeddings&quot;</span><span class="p">),</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;patch_embeddings&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span><span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;embeddings&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_embeddings&quot;</span><span class="p">,</span> <span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;attn&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span>
                <span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;attention&quot;</span><span class="p">,</span> <span class="s2">&quot;attention&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;attn&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span>
                <span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;attention&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;mlp&quot;</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span>
                <span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">y2</span><span class="p">,</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;intermediate&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span>
                <span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;norm1&quot;</span><span class="p">,</span> <span class="s2">&quot;layernorm_before&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;norm2&quot;</span><span class="p">,</span> <span class="s2">&quot;layernorm_after&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;final_norm&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="p">(</span><span class="s2">&quot;vit&quot;</span><span class="p">,</span> <span class="s2">&quot;layernorm&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">nonvisited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flax_model_params_fstate</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">params_name_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">key1</span> <span class="ow">in</span> <span class="n">flax_model_params_fstate</span><span class="p">,</span> <span class="n">key1</span>
        <span class="k">assert</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">tf_model_params_fstate</span><span class="p">,</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span>

        <span class="n">nonvisited</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>

        <span class="n">src_value</span> <span class="o">=</span> <span class="n">tf_model_params_fstate</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;kernel&quot;</span> <span class="ow">and</span> <span class="n">key2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">src_value</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">src_value</span> <span class="o">=</span> <span class="n">src_value</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">key2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span> <span class="ow">and</span> <span class="n">key2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">):</span>
            <span class="n">src_value</span> <span class="o">=</span> <span class="n">src_value</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">key2</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;attention&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">src_value</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">src_value</span> <span class="o">=</span> <span class="n">src_value</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">dst_value</span> <span class="o">=</span> <span class="n">flax_model_params_fstate</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">src_value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dst_value</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">src_value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">dst_value</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">dst_value</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">src_value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">dst_value</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">==</span> <span class="n">src_value</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">(</span><span class="n">dst_value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">src_value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonvisited</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nonvisited</span>
    <span class="n">nnx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dst_model</span><span class="p">,</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">from_flat_path</span><span class="p">(</span><span class="n">flax_model_params_fstate</span><span class="p">))</span>


<span class="n">vit_inplace_copy_weights</span><span class="p">(</span><span class="n">src_model</span><span class="o">=</span><span class="n">tf_model</span><span class="p">,</span> <span class="n">dst_model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check the pretrained weights of our model and compare with the reference model results</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ViTImageProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://images.cocodataset.org/val2017/000000039769.jpg&#39;</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">ViTImageProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;google/vit-base-patch16-224&#39;</span><span class="p">)</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">tf_model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span>


<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># model predicts one of the 1000 ImageNet classes</span>
<span class="n">ref_class_idx</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">pred_class_idx</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.1</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Reference model:</span><span class="se">\n</span><span class="si">{</span><span class="n">tf_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">id2label</span><span class="p">[</span><span class="n">ref_class_idx</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">P=</span><span class="si">{</span><span class="n">nnx</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ref_class_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Our model:</span><span class="se">\n</span><span class="si">{</span><span class="n">tf_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">id2label</span><span class="p">[</span><span class="n">pred_class_idx</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">P=</span><span class="si">{</span><span class="n">nnx</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pred_class_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f9b7db63d90&gt;
</pre></div>
</div>
<img alt="_images/c2de4112222627c4813d28b83e181d6e86282a6e8644f4219ec655a20cd97c8b.png" src="_images/c2de4112222627c4813d28b83e181d6e86282a6e8644f4219ec655a20cd97c8b.png" />
</div>
</div>
<p>However, for the image captioning task we need ViT model to return the sequence of tokens before the classification head:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_vit_encoder</span><span class="p">(</span>
    <span class="n">img_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
    <span class="n">patch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">mlp_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3072</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
    <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">use_pretained_weights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">encoder</span> <span class="o">=</span> <span class="n">VisionTransformer</span><span class="p">(</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
        <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
        <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
        <span class="n">mlp_dim</span><span class="o">=</span><span class="n">mlp_dim</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
        <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">use_pretained_weights</span><span class="p">:</span>
        <span class="n">tf_model</span> <span class="o">=</span> <span class="n">FlaxViTForImageClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;google/vit-base-patch16-224&#39;</span><span class="p">)</span>
        <span class="n">vit_inplace_copy_weights</span><span class="p">(</span><span class="n">src_model</span><span class="o">=</span><span class="n">tf_model</span><span class="p">,</span> <span class="n">dst_model</span><span class="o">=</span><span class="n">encoder</span><span class="p">)</span>

    <span class="n">encoder</span><span class="o">.</span><span class="n">include_top</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">encoder</span>


<span class="n">encoder</span> <span class="o">=</span> <span class="n">get_vit_encoder</span><span class="p">()</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image encoded sequence:&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Image encoded sequence: (4, 197, 768)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">model</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">tf_model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="transformer-decoder">
<h3>Transformer decoder<a class="headerlink" href="#transformer-decoder" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">causal_attention_mask</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">)))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PositionalEmbedding</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_embeddings</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_embeddings</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
        <span class="n">sequence_length</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">embedded_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_embeddings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">embedded_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_embeddings</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">embedded_tokens</span> <span class="o">+</span> <span class="n">embedded_positions</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TransformerDecoderLayer</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">mlp_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3072</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masked_self_mha</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">MultiHeadAttention</span><span class="p">(</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
            <span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">broadcast_dropout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">num_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_mha</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">MultiHeadAttention</span><span class="p">(</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
            <span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">broadcast_dropout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">num_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">mlp_dim</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">gelu</span><span class="p">,</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">mlp_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm3</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">num_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">decoder_input</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
        <span class="c1"># Self-attention part on decoder input</span>
        <span class="n">causal_mask</span> <span class="o">=</span> <span class="n">causal_attention_mask</span><span class="p">(</span><span class="n">decoder_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># (sequence_length, sequence_length)</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># mask shape: (N, sequence_length)</span>
            <span class="n">padding_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>  <span class="c1"># (N, 1, sequence_length, 1)</span>
            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>  <span class="c1"># (N, 1, sequence_length)</span>
            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span> <span class="n">causal_mask</span><span class="p">)</span>  <span class="c1"># (N, 1, sequence_length, sequence_length)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">causal_mask</span>
            <span class="n">padding_mask</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">attention_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_self_mha</span><span class="p">(</span><span class="n">inputs_q</span><span class="o">=</span><span class="n">decoder_input</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">combined_mask</span><span class="p">)</span>
        <span class="n">attention_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attention_output</span><span class="p">)</span>
        <span class="n">attention_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">decoder_input</span> <span class="o">+</span> <span class="n">attention_output</span><span class="p">)</span>

        <span class="c1"># Attention part on encoder input</span>
        <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_mha</span><span class="p">(</span>
            <span class="n">inputs_q</span><span class="o">=</span><span class="n">attention_output</span><span class="p">,</span>
            <span class="n">inputs_v</span><span class="o">=</span><span class="n">encoder_output</span><span class="p">,</span>
            <span class="n">inputs_k</span><span class="o">=</span><span class="n">encoder_output</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">padding_mask</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">decoder_output</span><span class="p">)</span>
        <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">decoder_output</span> <span class="o">+</span> <span class="n">attention_output</span><span class="p">)</span>

        <span class="c1"># Final MLP part</span>
        <span class="n">decoder_output</span> <span class="o">=</span> <span class="n">decoder_output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">decoder_output</span><span class="p">)</span>
        <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm3</span><span class="p">(</span><span class="n">decoder_output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">decoder_output</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TransformerDecoder</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">mlp_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3072</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positional_embedding</span> <span class="o">=</span> <span class="n">PositionalEmbedding</span><span class="p">(</span>
            <span class="n">sequence_length</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_blocks</span> <span class="o">=</span>  <span class="p">[</span>
            <span class="n">TransformerDecoderLayer</span><span class="p">(</span>
                <span class="n">num_heads</span><span class="p">,</span> <span class="n">mlp_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">decoder_input</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional_embedding</span><span class="p">(</span><span class="n">decoder_input</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_blocks</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="image-captioning-model">
<h3>Image Captioning Model<a class="headerlink" href="#image-captioning-model" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageCaptioningModel</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="c1"># encoder config:</span>
        <span class="n">img_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
        <span class="n">patch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">encoder_num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">encoder_num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">encoder_mlp_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3072</span><span class="p">,</span>
        <span class="n">use_pretained_encoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># decoder config:</span>
        <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50257</span><span class="p">,</span>
        <span class="n">decoder_sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">decoder_num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">decoder_num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">decoder_mlp_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3072</span><span class="p">,</span>
        <span class="c1"># other common config:</span>
        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Rngs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>

    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">get_vit_encoder</span><span class="p">(</span>
            <span class="n">img_size</span><span class="p">,</span>
            <span class="n">patch_size</span><span class="p">,</span>
            <span class="n">encoder_num_layers</span><span class="p">,</span>
            <span class="n">encoder_num_heads</span><span class="p">,</span>
            <span class="n">encoder_mlp_dim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
            <span class="n">use_pretained_weights</span><span class="o">=</span><span class="n">use_pretained_encoder</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">TransformerDecoder</span><span class="p">(</span>
            <span class="n">decoder_sequence_length</span><span class="p">,</span>
            <span class="n">vocab_size</span><span class="p">,</span>
            <span class="n">decoder_num_layers</span><span class="p">,</span>
            <span class="n">decoder_num_heads</span><span class="p">,</span>
            <span class="n">decoder_mlp_dim</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">decoder_input</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>

        <span class="n">encoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">decoder_input</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># (N, sequence_length, hidden_size)</span>

        <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">decoder_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">decoder_output</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">max_length</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">test_transforms</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="n">test_transforms</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">start_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">start_tag</span><span class="p">,</span>
        <span class="n">end_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">end_tag</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_transforms</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">max_tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_length</span>

        <span class="c1"># Create image representation</span>
        <span class="n">encoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">start_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">start_tag</span><span class="p">,</span> <span class="n">allowed_special</span><span class="o">=</span><span class="p">{</span><span class="n">start_tag</span><span class="p">,</span> <span class="n">end_tag</span><span class="p">})</span>
        <span class="n">end_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">end_tag</span><span class="p">,</span> <span class="n">allowed_special</span><span class="o">=</span><span class="p">{</span><span class="n">start_tag</span><span class="p">,</span> <span class="n">end_tag</span><span class="p">})</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sample_from</span><span class="p">(</span><span class="n">logits</span><span class="p">):</span>
            <span class="n">logits</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span> <span class="n">indices</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">generate_step</span><span class="p">(</span><span class="n">start_tokens</span><span class="p">):</span>
            <span class="c1"># Cut to max length and pad with zeros if needed</span>
            <span class="n">start_tokens</span> <span class="o">=</span> <span class="n">start_tokens</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
            <span class="n">sample_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">start_tokens</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_tokens</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_tokens</span><span class="p">)))</span>
            <span class="n">start_tokens</span> <span class="o">=</span> <span class="n">start_tokens</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">start_tokens</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">decoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">start_tokens</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">decoder_output</span><span class="p">)</span>
            <span class="n">next_token</span> <span class="o">=</span> <span class="n">sample_from</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">sample_index</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">next_token</span>

        <span class="n">generated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">):</span>
            <span class="n">next_token</span> <span class="o">=</span> <span class="n">generate_step</span><span class="p">(</span><span class="n">start_tokens</span> <span class="o">+</span> <span class="n">generated</span><span class="p">)</span>
            <span class="n">generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">next_token</span><span class="p">))</span>
            <span class="c1"># Truncate whatever is after end_tag</span>
            <span class="k">if</span> <span class="n">generated</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">end_tokens</span><span class="p">):]</span> <span class="o">==</span> <span class="n">end_tokens</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">generated</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">end_tokens</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ImageCaptioningModel</span><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">decoder_sequence_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize model’s architecture with <code class="docutils literal notranslate"><span class="pre">nnx.display(model)</span></code>.</p>
<p>Let’s make a smoke test of the model implementation and check the output shape: <code class="docutils literal notranslate"><span class="pre">(N,</span> <span class="pre">sequence_length,</span> <span class="pre">vocab_size)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">decoder_input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">decoder_input</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="n">pred_tokens</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">decoder_input</span><span class="o">=</span><span class="n">decoder_input</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predicted tokens shape:&quot;</span><span class="p">,</span> <span class="n">pred_tokens</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Predicted tokens shape: (4, 150, 50257)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="train-the-model">
<h2>Train the model<a class="headerlink" href="#train-the-model" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select all params and not those with the key containing &quot;encoder&quot;</span>
<span class="n">trainable_params_filter</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">All</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">Param</span><span class="p">,</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">nnx</span><span class="o">.</span><span class="n">PathContains</span><span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">)))</span>
<span class="n">model_diffstate</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">DiffState</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trainable_params_filter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">nnx</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">trainable_params_filter</span><span class="p">)</span><span class="o">.</span><span class="n">flat_state</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s2">&quot;encoder&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">optax</span>

<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.015</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">total_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">//</span> <span class="n">train_batch_size</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">ModelAndOptimizer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">optax</span><span class="o">.</span><span class="n">sgd</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">momentum</span><span class="p">,</span> <span class="n">nesterov</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">wrt</span><span class="o">=</span><span class="n">trainable_params_filter</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_losses_and_logits</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>

    <span class="n">input_tokens</span> <span class="o">=</span> <span class="n">target_tokens</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">padding_mask</span> <span class="o">=</span> <span class="n">input_tokens</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">target_tokens</span> <span class="o">=</span> <span class="n">target_tokens</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

    <span class="n">predicted_tokens</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">decoder_input</span><span class="o">=</span><span class="n">input_tokens</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">padding_mask</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">softmax_cross_entropy_with_integer_labels</span><span class="p">(</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">predicted_tokens</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">target_tokens</span>
    <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">predicted_tokens</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@nnx</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">train_step</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
<span class="p">):</span>
    <span class="c1"># Convert np.ndarray to jax.Array on GPU</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])</span>
    <span class="n">target_tokens</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span>
        <span class="n">compute_losses_and_logits</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="n">model_diffstate</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span>

    <span class="n">optimizer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>  <span class="c1"># In-place updates.</span>

    <span class="k">return</span> <span class="n">loss</span>


<span class="nd">@nnx</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">eval_step</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">eval_metrics</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">MultiMetric</span>
<span class="p">):</span>
    <span class="c1"># Convert np.ndarray to jax.Array on GPU</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])</span>
    <span class="n">target_tokens</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">pred_tokens</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_losses_and_logits</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span>

    <span class="n">eval_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">pred_tokens</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">target_tokens</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_metrics</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">MultiMetric</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">nnx</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Average</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">),</span>
    <span class="n">accuracy</span><span class="o">=</span><span class="n">nnx</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">(),</span>
<span class="p">)</span>


<span class="n">train_metrics_history</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>

<span class="n">eval_metrics_history</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;test_loss&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;test_accuracy&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>


<span class="n">bar_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2">[</span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2">]</span><span class="si">{postfix}</span><span class="s2"> [</span><span class="si">{elapsed}</span><span class="s2">&lt;</span><span class="si">{remaining}</span><span class="s2">]&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># Set model to the training mode: e.g. update batch statistics</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[train] epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">, &quot;</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="n">total_steps</span><span class="p">,</span>
        <span class="n">bar_format</span><span class="o">=</span><span class="n">bar_format</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">train_metrics_history</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()})</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="c1"># Compute the metrics on the train and val sets after each training epoch.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Set model to evaluation model: e.g. use stored batch statistics</span>

    <span class="n">eval_metrics</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># Reset the eval metrics</span>
    <span class="k">for</span> <span class="n">test_batch</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
        <span class="n">eval_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_batch</span><span class="p">,</span> <span class="n">eval_metrics</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">eval_metrics</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">eval_metrics_history</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[test] epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- total loss: </span><span class="si">{</span><span class="n">eval_metrics_history</span><span class="p">[</span><span class="s1">&#39;test_loss&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Accuracy: </span><span class="si">{</span><span class="n">eval_metrics_history</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">train_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">train_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[train] Caption prediction:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected caption: &#39;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicted caption: &#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">test_batch</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[test] Caption prediction:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected caption: &#39;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicted caption: &#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eval_metrics_history</span><span class="p">[</span><span class="s2">&quot;test_accuracy&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="n">path</span> <span class="o">=</span> <span class="n">ocp</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">erase_and_create_empty</span><span class="p">(</span><span class="s2">&quot;/tmp/output-image-captioning-model/&quot;</span><span class="p">)</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">ocp</span><span class="o">.</span><span class="n">CheckpointManagerOptions</span><span class="p">(</span><span class="n">max_to_keep</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mngr</span> <span class="o">=</span> <span class="n">ocp</span><span class="o">.</span><span class="n">CheckpointManager</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># We should convert PRNGKeyArray to the old format for Dropout layers</span>
    <span class="c1"># https://github.com/google/flax/issues/4231</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_key_data</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">prng</span><span class="o">.</span><span class="n">PRNGKeyArray</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">prng</span><span class="o">.</span><span class="n">KeyTy</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key_data</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="n">serializable_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_key_data</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">mngr</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">ocp</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">StandardSave</span><span class="p">(</span><span class="n">serializable_state</span><span class="p">))</span>
    <span class="n">mngr</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">test_every_epoch</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">best_test_accuracy</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">test_every_epoch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">num_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_accuracy</span> <span class="o">&gt;</span> <span class="n">best_test_accuracy</span><span class="p">:</span>
            <span class="n">save_model</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">best_test_accuracy</span> <span class="o">=</span> <span class="n">test_accuracy</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[test] epoch: 1/200
- total loss: 3.6159
- Accuracy: 0.5479
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;AA with a[[[[ [][ [] with [ [] with [ with the[[ a a a a a[ with the[[ with with a withend with a the with[ [end[ the with a a the the[[ with the with a the []A a the with the aend a a the the the with a aend a[ [ the[[ the [endend a with[ [ the with [ the a[ the[ the with the[ the[[ the[ the withend the with the[ the[ [ the [end a with [ the[ [ the a with[ the a[ the[ [end a the[ the with the[ the[&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39; a of [ in [ of [ of inend [ of ofend [[ in [ of[ [ of[ instart in [ ofstartend [ of in[ [end instartstart of in [[ in [ in[ in [[ [endendend in [endend instartendstartend instartend [end[ in[start ofstart in[[ [A [end[ in [A[ in[ [ in[start instart[ in [Astartstartstartend instartstart[ [[ [Aend instart[ in [ in[ in [[ [Astartstart in [ ofstartstart in [ ofstartstartstart in[ [ in[ in [[ of [[&#39;
[test] epoch: 11/200
- total loss: 2.0915
- Accuracy: 0.6840
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A dog in the brown and the snow with the ball&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A boy wearing a large a street on the beach&#39;
[test] epoch: 21/200
- total loss: 1.8263
- Accuracy: 0.7158
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A brown dog in the camera in a stick with the air&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A group of people standing with an other at a woman are in front of the beach&#39;
[test] epoch: 31/200
- total loss: 1.7046
- Accuracy: 0.7249
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A brown dog runs through a brown dog in a grass&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A woman wearing a woman wearing a city hat in the city and black&#39;
[test] epoch: 41/200
- total loss: 1.6248
- Accuracy: 0.7318
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and white dog and black and brown dog and white dog&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A woman wearing a white hat  black is standing in the road in the red  is looking at the road&#39;
[test] epoch: 51/200
- total loss: 1.5667
- Accuracy: 0.7364
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A brown dog with his dog on a large black and the snow&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple and woman sit at an adult is standing outside a stone road&#39;
[test] epoch: 61/200
- total loss: 1.5207
- Accuracy: 0.7393
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog are running down the snow&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple sitting at an obstacle by an obstacle at an older group of the camera&#39;
[test] epoch: 71/200
- total loss: 1.4856
- Accuracy: 0.7424
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A brown dog with his dog on his tongue&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple and two children sitting in the city of an obstacle&#39;
[test] epoch: 81/200
- total loss: 1.4545
- Accuracy: 0.7457
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog with his dog are biting his head in its mouth&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple and two children sitting down the background&#39;
[test] epoch: 91/200
- total loss: 1.4289
- Accuracy: 0.7485
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog and black dog in a grass&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple and woman in red shorts are walking through a large stone path&#39;
[test] epoch: 101/200
- total loss: 1.4062
- Accuracy: 0.7503
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and black dog in the black dog are biting another black dog on a rope&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple sit at an old couple of an older woman and sit in the distance&#39;
[test] epoch: 111/200
- total loss: 1.3891
- Accuracy: 0.7521
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A brown dog with his face up a leash is laying in his mouth&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple sit at an older people stand near the top of the end of the steps&#39;
[test] epoch: 121/200
- total loss: 1.3739
- Accuracy: 0.7538
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and black dog standing on the camera with his teeth in his mouth&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple sit at an old people stand under an event&#39;
[test] epoch: 131/200
- total loss: 1.3610
- Accuracy: 0.7554
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and black dog and brown dog is laying on a grassy field&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A couple sit at an old couple of an old couple and people look over the top of an obstacle&#39;
[test] epoch: 141/200
- total loss: 1.3499
- Accuracy: 0.7564
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and black dog biting his tongue hanging from another black dog&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people sitting down the steps&#39;
[test] epoch: 151/200
- total loss: 1.3412
- Accuracy: 0.7573
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog and a red dog standing next to the side of the water&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people are walking on the front of a table outside of an obstacle&#39;
[test] epoch: 161/200
- total loss: 1.3343
- Accuracy: 0.7578
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and black dog chewing on the red and looks on a leash&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people are walking on the road and walking under an outdoor tent&#39;
[test] epoch: 171/200
- total loss: 1.3293
- Accuracy: 0.7587
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog are walking along the dirt path&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people are walking on the steps outside a tree&#39;
[test] epoch: 181/200
- total loss: 1.3258
- Accuracy: 0.7589
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog biting the other brown and orange&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people are walking on the steps outside a table with her and people are looking out of the window&#39;
[test] epoch: 191/200
- total loss: 1.3220
- Accuracy: 0.7592
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog biting another black dog&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people are walking on the steps outside a table with people walking on it&#39;
[test] epoch: 200/200
- total loss: 1.3215
- Accuracy: 0.7591
[train] Caption prediction:
Expected caption: &#39;[start]A black and brown dogs pulling a red leash[end] [start]A black dog chewing on a red leash[end] [start]A dog chews on his red leash[end] [start]A dog of dark color holds a red leash in his mouth[end] [start]a dog tugs on his red leash[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A black and brown dog biting the face of the water&#39;

[test] Caption prediction:
Expected caption: &#39;[start]A couple of people sit outdoors at a table with an umbrella and talk[end] [start]Three people are sitting at an outside picnic bench with an umbrella[end] [start]Three people sit at an outdoor cafe[end] [start]Three people sit at an outdoor table in front of a building painted like the Union Jack[end] [start]Three people sit at a picnic table outside of a building painted like a union jack[end] !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;
Predicted caption: &#39;A bunch of people are walking on the lawn with an outdoor tent and the background&#39;

CPU times: user 24min 48s, sys: 5min 4s, total: 29min 53s
Wall time: 1h 29min 52s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[train] epoch: 0/200, [0/30] [00:00&lt;?]2024-11-27 13:31:46.330161: W external/xla/xla/service/hlo_rematerialization.cc:3005] Can&#39;t reduce memory use below 17.78GiB (19093871438 bytes) by rematerialization; only reduced to 18.33GiB (19681631480 bytes), down from 23.66GiB (25409501748 bytes) originally
[train] epoch: 0/200, [28/30], loss=3.6 [01:28&lt;00:06]
[train] epoch: 1/200, [28/30], loss=2.85 [00:23&lt;00:01]
[train] epoch: 2/200, [28/30], loss=2.61 [00:23&lt;00:01]
[train] epoch: 3/200, [28/30], loss=2.48 [00:23&lt;00:01]
[train] epoch: 4/200, [28/30], loss=2.38 [00:23&lt;00:01]
[train] epoch: 5/200, [28/30], loss=2.31 [00:23&lt;00:01]
[train] epoch: 6/200, [28/30], loss=2.24 [00:24&lt;00:01]
[train] epoch: 7/200, [28/30], loss=2.18 [00:23&lt;00:01]
[train] epoch: 8/200, [28/30], loss=2.12 [00:23&lt;00:01]
[train] epoch: 9/200, [28/30], loss=2.07 [00:23&lt;00:01]
[train] epoch: 10/200, [28/30], loss=2.02 [00:23&lt;00:01]
[train] epoch: 11/200, [28/30], loss=1.98 [00:23&lt;00:01]
[train] epoch: 12/200, [28/30], loss=1.95 [00:24&lt;00:01]
[train] epoch: 13/200, [28/30], loss=1.91 [00:23&lt;00:01]
[train] epoch: 14/200, [28/30], loss=1.88 [00:24&lt;00:01]
[train] epoch: 15/200, [28/30], loss=1.85 [00:24&lt;00:01]
[train] epoch: 16/200, [28/30], loss=1.83 [00:24&lt;00:01]
[train] epoch: 17/200, [28/30], loss=1.81 [00:24&lt;00:01]
[train] epoch: 18/200, [28/30], loss=1.79 [00:23&lt;00:01]
[train] epoch: 19/200, [28/30], loss=1.77 [00:24&lt;00:01]
[train] epoch: 20/200, [28/30], loss=1.75 [00:24&lt;00:01]
[train] epoch: 21/200, [28/30], loss=1.73 [00:23&lt;00:01]
[train] epoch: 22/200, [28/30], loss=1.72 [00:23&lt;00:01]
[train] epoch: 23/200, [28/30], loss=1.7 [00:24&lt;00:01] 
[train] epoch: 24/200, [28/30], loss=1.69 [00:24&lt;00:01]
[train] epoch: 25/200, [28/30], loss=1.67 [00:24&lt;00:01]
[train] epoch: 26/200, [28/30], loss=1.66 [00:24&lt;00:01]
[train] epoch: 27/200, [28/30], loss=1.65 [00:24&lt;00:01]
[train] epoch: 28/200, [28/30], loss=1.64 [00:23&lt;00:01]
[train] epoch: 29/200, [28/30], loss=1.63 [00:24&lt;00:01]
[train] epoch: 30/200, [28/30], loss=1.61 [00:23&lt;00:01]
[train] epoch: 31/200, [28/30], loss=1.6 [00:23&lt;00:01] 
[train] epoch: 32/200, [28/30], loss=1.59 [00:24&lt;00:01]
[train] epoch: 33/200, [28/30], loss=1.58 [00:23&lt;00:01]
[train] epoch: 34/200, [28/30], loss=1.57 [00:23&lt;00:01]
[train] epoch: 35/200, [28/30], loss=1.56 [00:24&lt;00:01]
[train] epoch: 36/200, [28/30], loss=1.56 [00:23&lt;00:01]
[train] epoch: 37/200, [28/30], loss=1.54 [00:23&lt;00:01]
[train] epoch: 38/200, [28/30], loss=1.54 [00:23&lt;00:01]
[train] epoch: 39/200, [28/30], loss=1.53 [00:23&lt;00:01]
[train] epoch: 40/200, [28/30], loss=1.52 [00:24&lt;00:01]
[train] epoch: 41/200, [28/30], loss=1.52 [00:23&lt;00:01]
[train] epoch: 42/200, [28/30], loss=1.5 [00:23&lt;00:01] 
[train] epoch: 43/200, [28/30], loss=1.5 [00:23&lt;00:01] 
[train] epoch: 44/200, [28/30], loss=1.49 [00:24&lt;00:01]
[train] epoch: 45/200, [28/30], loss=1.49 [00:23&lt;00:01]
[train] epoch: 46/200, [28/30], loss=1.48 [00:23&lt;00:01]
[train] epoch: 47/200, [28/30], loss=1.47 [00:23&lt;00:01]
[train] epoch: 48/200, [28/30], loss=1.46 [00:23&lt;00:01]
[train] epoch: 49/200, [28/30], loss=1.46 [00:24&lt;00:01]
[train] epoch: 50/200, [28/30], loss=1.45 [00:23&lt;00:01]
[train] epoch: 51/200, [28/30], loss=1.45 [00:23&lt;00:01]
[train] epoch: 52/200, [28/30], loss=1.44 [00:23&lt;00:01]
[train] epoch: 53/200, [28/30], loss=1.43 [00:23&lt;00:01]
[train] epoch: 54/200, [28/30], loss=1.42 [00:23&lt;00:01]
[train] epoch: 55/200, [28/30], loss=1.41 [00:23&lt;00:01]
[train] epoch: 56/200, [28/30], loss=1.41 [00:24&lt;00:01]
[train] epoch: 57/200, [28/30], loss=1.4 [00:23&lt;00:01] 
[train] epoch: 58/200, [28/30], loss=1.4 [00:23&lt;00:01] 
[train] epoch: 59/200, [28/30], loss=1.39 [00:23&lt;00:01]
[train] epoch: 60/200, [28/30], loss=1.39 [00:24&lt;00:01]
[train] epoch: 61/200, [28/30], loss=1.38 [00:23&lt;00:01]
[train] epoch: 62/200, [28/30], loss=1.38 [00:23&lt;00:01]
[train] epoch: 63/200, [28/30], loss=1.37 [00:23&lt;00:01]
[train] epoch: 64/200, [28/30], loss=1.37 [00:23&lt;00:01]
[train] epoch: 65/200, [28/30], loss=1.36 [00:23&lt;00:01]
[train] epoch: 66/200, [28/30], loss=1.36 [00:23&lt;00:01]
[train] epoch: 67/200, [28/30], loss=1.35 [00:23&lt;00:01]
[train] epoch: 68/200, [28/30], loss=1.35 [00:23&lt;00:01]
[train] epoch: 69/200, [28/30], loss=1.34 [00:23&lt;00:01]
[train] epoch: 70/200, [28/30], loss=1.34 [00:23&lt;00:01]
[train] epoch: 71/200, [28/30], loss=1.33 [00:23&lt;00:01]
[train] epoch: 72/200, [28/30], loss=1.33 [00:23&lt;00:01]
[train] epoch: 73/200, [28/30], loss=1.32 [00:23&lt;00:01]
[train] epoch: 74/200, [28/30], loss=1.32 [00:23&lt;00:01]
[train] epoch: 75/200, [28/30], loss=1.31 [00:23&lt;00:01]
[train] epoch: 76/200, [28/30], loss=1.31 [00:23&lt;00:01]
[train] epoch: 77/200, [28/30], loss=1.31 [00:24&lt;00:01]
[train] epoch: 78/200, [28/30], loss=1.3 [00:24&lt;00:01] 
[train] epoch: 79/200, [28/30], loss=1.29 [00:24&lt;00:01]
[train] epoch: 80/200, [28/30], loss=1.3 [00:23&lt;00:01]
[train] epoch: 81/200, [28/30], loss=1.28 [00:23&lt;00:01]
[train] epoch: 82/200, [28/30], loss=1.28 [00:23&lt;00:01]
[train] epoch: 83/200, [28/30], loss=1.28 [00:23&lt;00:01]
[train] epoch: 84/200, [28/30], loss=1.27 [00:23&lt;00:01]
[train] epoch: 85/200, [28/30], loss=1.27 [00:23&lt;00:01]
[train] epoch: 86/200, [28/30], loss=1.26 [00:23&lt;00:01]
[train] epoch: 87/200, [28/30], loss=1.26 [00:23&lt;00:01]
[train] epoch: 88/200, [28/30], loss=1.26 [00:23&lt;00:01]
[train] epoch: 89/200, [28/30], loss=1.25 [00:23&lt;00:01]
[train] epoch: 90/200, [28/30], loss=1.25 [00:23&lt;00:01]
[train] epoch: 91/200, [28/30], loss=1.24 [00:23&lt;00:01]
[train] epoch: 92/200, [28/30], loss=1.24 [00:23&lt;00:01]
[train] epoch: 93/200, [28/30], loss=1.24 [00:23&lt;00:01]
[train] epoch: 94/200, [28/30], loss=1.23 [00:23&lt;00:01]
[train] epoch: 95/200, [28/30], loss=1.23 [00:23&lt;00:01]
[train] epoch: 96/200, [28/30], loss=1.23 [00:23&lt;00:01]
[train] epoch: 97/200, [28/30], loss=1.22 [00:23&lt;00:01]
[train] epoch: 98/200, [28/30], loss=1.22 [00:24&lt;00:01]
[train] epoch: 99/200, [28/30], loss=1.21 [00:24&lt;00:01]
[train] epoch: 100/200, [28/30], loss=1.21 [00:23&lt;00:01]
[train] epoch: 101/200, [28/30], loss=1.2 [00:24&lt;00:01] 
[train] epoch: 102/200, [28/30], loss=1.2 [00:23&lt;00:01] 
[train] epoch: 103/200, [28/30], loss=1.2 [00:24&lt;00:01] 
[train] epoch: 104/200, [28/30], loss=1.2 [00:23&lt;00:01] 
[train] epoch: 105/200, [28/30], loss=1.19 [00:23&lt;00:01]
[train] epoch: 106/200, [28/30], loss=1.19 [00:23&lt;00:01]
[train] epoch: 107/200, [28/30], loss=1.18 [00:23&lt;00:01]
[train] epoch: 108/200, [28/30], loss=1.18 [00:23&lt;00:01]
[train] epoch: 109/200, [28/30], loss=1.18 [00:24&lt;00:01]
[train] epoch: 110/200, [28/30], loss=1.17 [00:24&lt;00:01]
[train] epoch: 111/200, [28/30], loss=1.17 [00:23&lt;00:01]
[train] epoch: 112/200, [28/30], loss=1.17 [00:23&lt;00:01]
[train] epoch: 113/200, [28/30], loss=1.16 [00:23&lt;00:01]
[train] epoch: 114/200, [28/30], loss=1.16 [00:23&lt;00:01]
[train] epoch: 115/200, [28/30], loss=1.15 [00:23&lt;00:01]
[train] epoch: 116/200, [28/30], loss=1.15 [00:23&lt;00:01]
[train] epoch: 117/200, [28/30], loss=1.14 [00:23&lt;00:01]
[train] epoch: 118/200, [28/30], loss=1.15 [00:23&lt;00:01]
[train] epoch: 119/200, [28/30], loss=1.14 [00:23&lt;00:01]
[train] epoch: 120/200, [28/30], loss=1.14 [00:23&lt;00:01]
[train] epoch: 121/200, [28/30], loss=1.14 [00:23&lt;00:01]
[train] epoch: 122/200, [28/30], loss=1.13 [00:23&lt;00:01]
[train] epoch: 123/200, [28/30], loss=1.13 [00:24&lt;00:01]
[train] epoch: 124/200, [28/30], loss=1.13 [00:24&lt;00:01]
[train] epoch: 125/200, [28/30], loss=1.13 [00:23&lt;00:01]
[train] epoch: 126/200, [28/30], loss=1.12 [00:23&lt;00:01]
[train] epoch: 127/200, [28/30], loss=1.12 [00:23&lt;00:01]
[train] epoch: 128/200, [28/30], loss=1.12 [00:23&lt;00:01]
[train] epoch: 129/200, [28/30], loss=1.11 [00:23&lt;00:01]
[train] epoch: 130/200, [28/30], loss=1.11 [00:23&lt;00:01]
[train] epoch: 131/200, [28/30], loss=1.11 [00:24&lt;00:01]
[train] epoch: 132/200, [28/30], loss=1.1 [00:23&lt;00:01] 
[train] epoch: 133/200, [28/30], loss=1.1 [00:24&lt;00:01] 
[train] epoch: 134/200, [28/30], loss=1.1 [00:24&lt;00:01] 
[train] epoch: 135/200, [28/30], loss=1.09 [00:23&lt;00:01]
[train] epoch: 136/200, [28/30], loss=1.09 [00:24&lt;00:01]
[train] epoch: 137/200, [28/30], loss=1.09 [00:23&lt;00:01]
[train] epoch: 138/200, [28/30], loss=1.09 [00:23&lt;00:01]
[train] epoch: 139/200, [28/30], loss=1.09 [00:23&lt;00:01]
[train] epoch: 140/200, [28/30], loss=1.08 [00:23&lt;00:01]
[train] epoch: 141/200, [28/30], loss=1.08 [00:23&lt;00:01]
[train] epoch: 142/200, [28/30], loss=1.07 [00:23&lt;00:01]
[train] epoch: 143/200, [28/30], loss=1.07 [00:23&lt;00:01]
[train] epoch: 144/200, [28/30], loss=1.07 [00:23&lt;00:01]
[train] epoch: 145/200, [28/30], loss=1.07 [00:23&lt;00:01]
[train] epoch: 146/200, [28/30], loss=1.07 [00:23&lt;00:01]
[train] epoch: 147/200, [28/30], loss=1.06 [00:23&lt;00:01]
[train] epoch: 148/200, [28/30], loss=1.06 [00:23&lt;00:01]
[train] epoch: 149/200, [28/30], loss=1.05 [00:23&lt;00:01]
[train] epoch: 150/200, [28/30], loss=1.05 [00:24&lt;00:01]
[train] epoch: 151/200, [28/30], loss=1.05 [00:23&lt;00:01]
[train] epoch: 152/200, [28/30], loss=1.04 [00:23&lt;00:01]
[train] epoch: 153/200, [28/30], loss=1.04 [00:24&lt;00:01]
[train] epoch: 154/200, [28/30], loss=1.04 [00:24&lt;00:01]
[train] epoch: 155/200, [28/30], loss=1.04 [00:23&lt;00:01]
[train] epoch: 156/200, [28/30], loss=1.04 [00:23&lt;00:01]
[train] epoch: 157/200, [28/30], loss=1.03 [00:23&lt;00:01]
[train] epoch: 158/200, [28/30], loss=1.03 [00:23&lt;00:01]
[train] epoch: 159/200, [28/30], loss=1.03 [00:23&lt;00:01]
[train] epoch: 160/200, [28/30], loss=1.03 [00:24&lt;00:01]
[train] epoch: 161/200, [28/30], loss=1.02 [00:23&lt;00:01]
[train] epoch: 162/200, [28/30], loss=1.02 [00:24&lt;00:01]
[train] epoch: 163/200, [28/30], loss=1.02 [00:24&lt;00:01] 
[train] epoch: 164/200, [28/30], loss=1.01 [00:24&lt;00:01] 
[train] epoch: 165/200, [28/30], loss=1.01 [00:23&lt;00:01] 
[train] epoch: 166/200, [28/30], loss=1.01 [00:24&lt;00:01] 
[train] epoch: 167/200, [28/30], loss=1.01 [00:23&lt;00:01] 
[train] epoch: 168/200, [28/30], loss=1.01 [00:23&lt;00:01] 
[train] epoch: 169/200, [28/30], loss=1 [00:23&lt;00:01]    
[train] epoch: 170/200, [28/30], loss=0.996 [00:24&lt;00:01]
[train] epoch: 171/200, [28/30], loss=0.996 [00:24&lt;00:01]
[train] epoch: 172/200, [28/30], loss=0.994 [00:24&lt;00:01]
[train] epoch: 173/200, [28/30], loss=0.995 [00:24&lt;00:01]
[train] epoch: 174/200, [28/30], loss=0.99 [00:23&lt;00:01] 
[train] epoch: 175/200, [28/30], loss=0.987 [00:24&lt;00:01]
[train] epoch: 176/200, [28/30], loss=0.982 [00:24&lt;00:01]
[train] epoch: 177/200, [28/30], loss=0.978 [00:24&lt;00:01]
[train] epoch: 178/200, [28/30], loss=0.978 [00:24&lt;00:01]
[train] epoch: 179/200, [28/30], loss=0.976 [00:23&lt;00:01]
[train] epoch: 180/200, [28/30], loss=0.97 [00:23&lt;00:01]
[train] epoch: 181/200, [28/30], loss=0.97 [00:23&lt;00:01] 
[train] epoch: 182/200, [28/30], loss=0.967 [00:23&lt;00:01]
[train] epoch: 183/200, [28/30], loss=0.962 [00:23&lt;00:01]
[train] epoch: 184/200, [28/30], loss=0.96 [00:24&lt;00:01] 
[train] epoch: 185/200, [28/30], loss=0.957 [00:24&lt;00:01]
[train] epoch: 186/200, [28/30], loss=0.953 [00:24&lt;00:01]
[train] epoch: 187/200, [28/30], loss=0.954 [00:23&lt;00:01]
[train] epoch: 188/200, [28/30], loss=0.955 [00:23&lt;00:01]
[train] epoch: 189/200, [28/30], loss=0.953 [00:24&lt;00:01]
[train] epoch: 190/200, [28/30], loss=0.95 [00:23&lt;00:01]
[train] epoch: 191/200, [28/30], loss=0.944 [00:23&lt;00:01]
[train] epoch: 192/200, [28/30], loss=0.942 [00:23&lt;00:01]
[train] epoch: 193/200, [28/30], loss=0.939 [00:24&lt;00:01]
[train] epoch: 194/200, [28/30], loss=0.936 [00:24&lt;00:01]
[train] epoch: 195/200, [28/30], loss=0.935 [00:24&lt;00:01]
[train] epoch: 196/200, [28/30], loss=0.935 [00:23&lt;00:01]
[train] epoch: 197/200, [28/30], loss=0.926 [00:23&lt;00:01]
[train] epoch: 198/200, [28/30], loss=0.929 [00:24&lt;00:01]
[train] epoch: 199/200, [28/30], loss=0.924 [00:24&lt;00:01]
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize collected metrics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_metrics_history</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Loss value during the training&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fa1b6d24ed0&gt;
</pre></div>
</div>
<img alt="_images/47340334c3e5a66e91ba5eb32b890217805a7670063a1573f576d8ae9d7f2ba8.png" src="_images/47340334c3e5a66e91ba5eb32b890217805a7670063a1573f576d8ae9d7f2ba8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="p">[</span><span class="n">epoch</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">test_every_epoch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">num_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Loss value on test set&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">eval_metrics_history</span><span class="p">[</span><span class="s2">&quot;test_loss&quot;</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Accuracy on test set&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">eval_metrics_history</span><span class="p">[</span><span class="s2">&quot;test_accuracy&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7f9b7572c3d0&gt;]
</pre></div>
</div>
<img alt="_images/df3eb2b367cc377aad91eb89cb538f63e1921f8a6b5c0d40ae2aa3ac85238b97.png" src="_images/df3eb2b367cc377aad91eb89cb538f63e1921f8a6b5c0d40ae2aa3ac85238b97.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url1</span> <span class="o">=</span> <span class="s2">&quot;http://images.cocodataset.org/val2017/000000039769.jpg&quot;</span>
<span class="n">url2</span> <span class="o">=</span> <span class="s2">&quot;https://farm2.staticflickr.com/1152/1151216944_1525126615_z.jpg&quot;</span>
<span class="n">url3</span> <span class="o">=</span> <span class="s2">&quot;http://farm7.staticflickr.com/6206/6123723223_4113967b1e_z.jpg&quot;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">pil_image</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;Test image&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url1</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;Test image&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url2</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;Test image&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url3</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;Train image&quot;</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">35</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Train image&quot;</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">45</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Train image&quot;</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">75</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]),</span>
<span class="p">]):</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">3</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">3</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pil_image</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/501a5f75e5ffbd18f5acb58716a48d3f99e8bbd4e44fef96dca097a023a41885.png" src="_images/501a5f75e5ffbd18f5acb58716a48d3f99e8bbd4e44fef96dca097a023a41885.png" />
</div>
</div>
</section>
<section id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Link to this heading">#</a></h2>
<p>In this tutorial we implemented and trained a transformer-based model for image captioning task. We used a pretrained frozen Vision Transformer encoder and trained a small decoder to predict the next token. Observed generation capabilities of the trained model are not great. Next steps could be (1) to use larger decoder, (2) to unfreeze few top encoder layers, (3) try other decoder architectures.</p>
<ul class="simple">
<li><p>Freezing model’s parameters using trainable parameters filtering: <a class="reference external" href="https://flax.readthedocs.io/en/latest/api_reference/flax.nnx/training/optimizer.html#flax.nnx.optimizer.Optimizer.update">example 1</a> and <a class="reference external" href="https://github.com/google/flax/issues/4167#issuecomment-2324245208">example 2</a>.</p></li>
<li><p>Other Computer Vision tutorials in <a class="reference external" href="https://jax-ai-stack.readthedocs.io/en/latest/getting_started.html">jax-ai-stack</a>.</p></li>
<li><p><a class="reference external" href="https://jax-ai-stack.readthedocs.io/en/latest/JAX_for_LLM_pretraining.html">LLM pretraining for text generation</a>.</p></li>
</ul>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="JAX_examples_image_segmentation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Image segmentation with UNETR model</p>
      </div>
    </a>
    <a class="right-next"
       href="JAX_Vision_transformer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Train a Vision Transformer (ViT) for image classification with JAX</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-image-captioning-dataset-and-dataloaders">Prepare image captioning dataset and dataloaders</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model">Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pretrained-vision-transformer">Pretrained Vision Transformer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transformer-decoder">Transformer decoder</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-captioning-model">Image Captioning Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-the-model">Train the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further reading</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By JAX team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, JAX team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>